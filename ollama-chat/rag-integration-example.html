<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG-Enhanced Chat - Example</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .mode-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:not(.active) {
            background: #e2e8f0;
            color: #4a5568;
        }

        .chat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .chat-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .panel-header {
            background: #4a5568;
            color: white;
            padding: 15px 20px;
            border-radius: 15px 15px 0 0;
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            background: #f7fafc;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
        }

        .sources {
            background: #f7fafc;
            border-left: 3px solid #667eea;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .source-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 5px;
        }

        .input-area {
            padding: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .input-box {
            display: flex;
            gap: 10px;
        }

        .input-box input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .send-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .login-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .auth-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .status.success {
            background: #c6f6d5;
            color: #22543d;
            display: block;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            display: block;
        }

        .model-selector {
            margin-top: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .model-selector label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        .model-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95em;
            background: white;
            cursor: pointer;
        }

        .model-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .model-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .model-install-btn {
            padding: 8px 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .model-install-btn:hover {
            background: #38a169;
        }

        .model-install-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .model-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
            cursor: pointer;
        }

        .model-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .model-input optgroup {
            font-weight: bold;
            color: #2d3748;
        }

        .model-input option {
            padding: 5px;
        }

        .install-progress {
            margin-top: 10px;
            padding: 10px;
            background: #edf2f7;
            border-radius: 6px;
            font-size: 0.9em;
            color: #4a5568;
            display: none;
        }

        .install-progress.active {
            display: block;
        }

        @media (max-width: 768px) {
            .chat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 RAG-Enhanced Chat - Integration Example</h1>
            <p>This demonstrates the difference between direct Ollama chat and RAG-enhanced responses</p>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="switchMode('compare')">Compare Mode</button>
                <button class="mode-btn" onclick="switchMode('rag-only')">RAG Only</button>
                <button class="mode-btn" onclick="switchMode('ollama-only')">Ollama Only</button>
            </div>
            <div class="model-selector">
                <label for="modelSelect">🤖 Ollama Model:</label>
                <select id="modelSelect" onchange="updateModel()">
                    <option value="">Loading models...</option>
                </select>
                <div class="model-actions">
                    <select id="modelInput" class="model-input">
                        <option value="">Loading available models...</option>
                    </select>
                    <button class="model-install-btn" onclick="installModel()">📥 Install Model</button>
                </div>
                <div id="installProgress" class="install-progress"></div>
            </div>
        </div>

        <div class="login-panel" id="loginPanel">
            <h3>Authentication Required for RAG Mode</h3>
            <p style="color: #718096; margin-bottom: 20px;">
                To use RAG-enhanced mode, please login to the RAG SpecKit system.
            </p>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" placeholder="admin@enterprise-rag.com" value="admin@enterprise-rag.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="Password" value="admin123">
            </div>
            <button class="auth-btn" onclick="login()">Login</button>
            <div class="status" id="authStatus"></div>
        </div>

        <div class="chat-grid" id="chatGrid" style="display: none;">
            <div class="chat-panel">
                <div class="panel-header">
                    <h3>🦙 Direct Ollama Chat</h3>
                    <small>Simple LLM responses without document context</small>
                </div>
                <div class="panel-body" id="ollamaMessages">
                    <div class="message">
                        <div class="message-content">
                            Hello! I'm Ollama. I'll answer based on my training data.
                        </div>
                    </div>
                </div>
                <div class="input-area">
                    <div class="input-box">
                        <input type="text" id="ollamaInput" placeholder="Ask Ollama...">
                        <button class="send-btn" onclick="sendOllama()">Send</button>
                    </div>
                </div>
            </div>

            <div class="chat-panel">
                <div class="panel-header">
                    <h3>🎯 RAG-Enhanced Chat</h3>
                    <small>Context-aware responses with document citations</small>
                </div>
                <div class="panel-body" id="ragMessages">
                    <div class="message">
                        <div class="message-content">
                            Hello! I'm RAG-enhanced. I'll answer using your uploaded documents as context.
                        </div>
                    </div>
                </div>
                <div class="input-area">
                    <div class="input-box">
                        <input type="text" id="ragInput" placeholder="Ask with RAG context...">
                        <button class="send-btn" onclick="sendRAG()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            authUrl: 'http://localhost:8081/api/v1',
            coreUrl: 'http://localhost:8084/api/v1',
            ollamaUrl: 'http://localhost:11434',
            ollamaModel: 'llama3.2:1b'
        };

        let accessToken = null;
        let tenantId = null;

        // Decode JWT token to extract claims
        function decodeJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('Failed to decode JWT:', e);
                return null;
            }
        }

        // Load available models on page load
        async function loadModels() {
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.innerHTML = '<option value="">Loading models...</option>';
            modelSelect.disabled = true;

            try {
                const response = await fetch(`${config.ollamaUrl}/api/tags`);
                const data = await response.json();
                const models = data.models || [];

                modelSelect.innerHTML = '';

                if (models.length === 0) {
                    modelSelect.innerHTML = '<option value="">No models available</option>';
                    return;
                }

                // Sort models by name
                models.sort((a, b) => a.name.localeCompare(b.name));

                models.forEach((model, index) => {
                    const option = document.createElement('option');
                    option.value = model.name;

                    // Add size info if available
                    let displayName = model.name;
                    if (model.size) {
                        const sizeGB = (model.size / (1024 * 1024 * 1024)).toFixed(1);
                        displayName += ` (${sizeGB}GB)`;
                    }

                    option.textContent = displayName;
                    option.selected = model.name === config.ollamaModel || (index === 0 && !config.ollamaModel);
                    modelSelect.appendChild(option);
                });

                // Set config to selected model
                config.ollamaModel = modelSelect.value;
            } catch (error) {
                console.error('Failed to load models:', error);
                modelSelect.innerHTML = '<option value="">Error loading models</option>';
            } finally {
                modelSelect.disabled = false;
            }
        }

        // Update selected model
        function updateModel() {
            const modelSelect = document.getElementById('modelSelect');
            config.ollamaModel = modelSelect.value;
            console.log('Model updated to:', config.ollamaModel);
        }

        // Install a new model
        async function installModel() {
            const modelInput = document.getElementById('modelInput');
            const installBtn = document.querySelector('.model-install-btn');
            const progressDiv = document.getElementById('installProgress');
            const modelName = modelInput.value.trim();

            if (!modelName) {
                progressDiv.className = 'install-progress active';
                progressDiv.textContent = '❌ Please enter a model name';
                progressDiv.style.background = '#fed7d7';
                progressDiv.style.color = '#742a2a';
                setTimeout(() => {
                    progressDiv.className = 'install-progress';
                }, 3000);
                return;
            }

            // Disable UI during installation
            installBtn.disabled = true;
            modelInput.disabled = true;
            progressDiv.className = 'install-progress active';
            progressDiv.style.background = '#edf2f7';
            progressDiv.style.color = '#4a5568';
            progressDiv.textContent = `⏳ Installing ${modelName}... This may take several minutes.`;

            try {
                const response = await fetch(`${config.ollamaUrl}/api/pull`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: modelName, stream: true })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let lastStatus = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim());

                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line);
                            if (data.status) {
                                lastStatus = data.status;
                                let progressMsg = `⏳ ${data.status}`;

                                if (data.completed && data.total) {
                                    const percent = ((data.completed / data.total) * 100).toFixed(1);
                                    const completedMB = (data.completed / (1024 * 1024)).toFixed(1);
                                    const totalMB = (data.total / (1024 * 1024)).toFixed(1);
                                    progressMsg += ` (${percent}% - ${completedMB}/${totalMB} MB)`;
                                }

                                progressDiv.textContent = progressMsg;
                            }
                        } catch (e) {
                            // Skip invalid JSON lines
                        }
                    }
                }

                // Success
                progressDiv.style.background = '#c6f6d5';
                progressDiv.style.color = '#22543d';
                progressDiv.textContent = `✅ Successfully installed ${modelName}!`;

                // Reload models
                setTimeout(async () => {
                    await loadModels();
                    modelInput.value = '';
                    progressDiv.className = 'install-progress';
                }, 2000);

            } catch (error) {
                console.error('Installation error:', error);
                progressDiv.style.background = '#fed7d7';
                progressDiv.style.color = '#742a2a';
                progressDiv.textContent = `❌ Failed to install ${modelName}: ${error.message}`;
            } finally {
                installBtn.disabled = false;
                modelInput.disabled = false;
            }
        }

        // Load available models from Ollama library
        async function loadAvailableModels() {
            const modelInput = document.getElementById('modelInput');

            // Popular Ollama models categorized by size
            const popularModels = [
                { name: 'llama3.2:1b', desc: 'Llama 3.2 1B - Fastest (1.3GB)', category: 'Small' },
                { name: 'qwen2:0.5b', desc: 'Qwen 2 0.5B - Tiny & Fast (352MB)', category: 'Small' },
                { name: 'phi3:mini', desc: 'Phi 3 Mini - Efficient (2.3GB)', category: 'Small' },
                { name: 'llama3.2:3b', desc: 'Llama 3.2 3B - Balanced (2GB)', category: 'Medium' },
                { name: 'gemma2:2b', desc: 'Gemma 2 2B - Google (1.6GB)', category: 'Medium' },
                { name: 'mistral:7b', desc: 'Mistral 7B - High Quality (4.1GB)', category: 'Large' },
                { name: 'llama3.1:8b', desc: 'Llama 3.1 8B - Latest (4.7GB)', category: 'Large' },
                { name: 'codellama:7b', desc: 'Code Llama 7B - Coding (3.8GB)', category: 'Large' },
                { name: 'qwen2.5-coder:7b', desc: 'Qwen Coder 7B - Programming (4.7GB)', category: 'Large' },
                { name: 'deepseek-coder:6.7b', desc: 'DeepSeek Coder 6.7B - Code (3.8GB)', category: 'Large' }
            ];

            modelInput.innerHTML = '<option value="">Select a model to install...</option>';

            let currentCategory = '';
            popularModels.forEach(model => {
                if (model.category !== currentCategory) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = `${model.category} Models`;
                    modelInput.appendChild(optgroup);
                    currentCategory = model.category;
                }

                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = model.desc;
                modelInput.lastChild.appendChild(option);
            });
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadModels();
            loadAvailableModels();
        });

        // Authentication
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const status = document.getElementById('authStatus');

            try {
                const response = await fetch(`${config.authUrl}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.accessToken;

                    // Extract tenantId from JWT token claims
                    const tokenClaims = decodeJWT(accessToken);
                    tenantId = tokenClaims?.tenantId || null;

                    console.log('Login successful!');
                    console.log('JWT Claims:', tokenClaims);
                    console.log('Extracted tenantId:', tenantId);

                    status.className = 'status success';
                    status.textContent = '✓ Login successful!';

                    setTimeout(() => {
                        document.getElementById('loginPanel').style.display = 'none';
                        document.getElementById('chatGrid').style.display = 'grid';
                    }, 1000);
                } else {
                    throw new Error('Login failed');
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = `✗ ${error.message}. Note: This is a demo - actual auth service must be running.`;
            }
        }

        // Send message to Ollama
        async function sendOllama() {
            const input = document.getElementById('ollamaInput');
            const query = input.value.trim();
            if (!query) return;

            const messagesDiv = document.getElementById('ollamaMessages');

            // Add user message
            messagesDiv.innerHTML += `
                <div class="message user">
                    <div class="message-content">${query}</div>
                </div>
            `;

            input.value = '';

            // Add placeholder for response
            const responsePlaceholder = document.createElement('div');
            responsePlaceholder.className = 'message';
            responsePlaceholder.innerHTML = '<div class="message-content">Thinking...</div>';
            messagesDiv.appendChild(responsePlaceholder);

            try {
                const response = await fetch(`${config.ollamaUrl}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: config.ollamaModel || 'llama3.2:1b',
                        prompt: query,
                        stream: false
                    })
                });

                const data = await response.json();
                responsePlaceholder.innerHTML = `
                    <div class="message-content">${data.response}</div>
                `;
            } catch (error) {
                responsePlaceholder.innerHTML = `
                    <div class="message-content" style="color: red;">
                        Error: ${error.message}<br>
                        <small>Make sure Ollama is running: docker-compose up ollama</small>
                    </div>
                `;
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Send message to RAG
        async function sendRAG() {
            const input = document.getElementById('ragInput');
            const query = input.value.trim();
            if (!query) return;

            const messagesDiv = document.getElementById('ragMessages');

            // Add user message
            messagesDiv.innerHTML += `
                <div class="message user">
                    <div class="message-content">${query}</div>
                </div>
            `;

            input.value = '';

            // Add placeholder for response
            const responsePlaceholder = document.createElement('div');
            responsePlaceholder.className = 'message';
            responsePlaceholder.innerHTML = '<div class="message-content">Searching documents and generating response...</div>';
            messagesDiv.appendChild(responsePlaceholder);

            try {
                console.log('Sending RAG query with tenantId:', tenantId);
                const response = await fetch(`${config.coreUrl}/rag/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'X-Tenant-ID': tenantId
                    },
                    body: JSON.stringify({
                        tenantId,
                        query,
                        includeContext: true,
                        topK: 5
                    })
                });

                const data = await response.json();

                // Build sources HTML
                let sourcesHtml = '';
                if (data.sources && data.sources.length > 0) {
                    sourcesHtml = '<div class="sources"><strong>📚 Sources:</strong>';
                    data.sources.forEach((source, idx) => {
                        sourcesHtml += `
                            <div class="source-item">
                                ${idx + 1}. ${source.fileName} (Score: ${(source.relevanceScore * 100).toFixed(1)}%)
                                <br><small>${source.excerpt.substring(0, 100)}...</small>
                            </div>
                        `;
                    });
                    sourcesHtml += '</div>';
                }

                responsePlaceholder.innerHTML = `
                    <div class="message-content">
                        ${data.response}
                        ${sourcesHtml}
                    </div>
                `;
            } catch (error) {
                responsePlaceholder.innerHTML = `
                    <div class="message-content" style="color: red;">
                        Error: ${error.message}<br>
                        <small>Make sure RAG services are running: docker-compose up</small>
                    </div>
                `;
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Mode switching
        function switchMode(mode) {
            // Update button states
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide panels based on mode
            const panels = document.querySelectorAll('.chat-panel');
            if (mode === 'rag-only') {
                panels[0].style.display = 'none';
                panels[1].style.display = 'flex';
            } else if (mode === 'ollama-only') {
                panels[0].style.display = 'flex';
                panels[1].style.display = 'none';
            } else {
                panels[0].style.display = 'flex';
                panels[1].style.display = 'flex';
            }
        }

        // Keyboard shortcuts
        document.getElementById('ollamaInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendOllama();
        });

        document.getElementById('ragInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendRAG();
        });
    </script>
</body>
</html>
